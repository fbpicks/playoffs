<!DOCTYPE html>
<html>
<head>
  <title>Fantasy Football Playoffs</title>
  <link rel="shortcut icon" href="https://dl.dropboxusercontent.com/s/d8kuo01repoyfif/favicon.ico?raw=1" />
  <meta charset="utf-8"/>
</head>

<body>
<div id="main_table"></div>
<div id="team_table" style="display:none"></div>
<div id="loading" style="text-align:center;font-weight:bold;font-size:36px">Loading...</div>

<script>
/* ================= CONFIG ================= */

const player_list = 'https://script.google.com/macros/s/AKfycbw_IEatKou94Fg0V2LYXxgZabsxGCAywoVZRnJSIGi3O4-tOxYW25W7Z3Iyy9pyh6HZWg/exec';
const rosters = 'https://dl.dropboxusercontent.com/scl/fi/a1zbppnhobvpedseotrv2/PlayoffRoster.csv?rlkey=6156w2svj196b30iqztgq42&st=pv0keaq6&dl=0&raw=1';

/* ================= GLOBALS ================= */

let players = [];
let roster = {};
let playerMap = {};
let teamMap = {};
let originalTeamTable;

/* ================= INIT ================= */

window.onload = async () => {
  originalTeamTable = document.getElementById('team_table').cloneNode(true);
  await loadData();
  buildLookups();
  buildStandings();
  document.getElementById('loading').style.display = 'none';
};

/* ================= DATA LOADING ================= */

async function loadData() {
  // Load Google Sheet with fetch
  const playersPromise = fetch(player_list).then(r => r.json());

  // Load Dropbox CSV with XHR (Dropbox blocks fetch)
  const rosterPromise = loadCSVXHR(rosters);

  const [playersRes, rosterText] = await Promise.all([
    playersPromise,
    rosterPromise
  ]);

  players = playersRes.data;
  roster = parseFlatCSV(rosterText, 4);
}

/* ================= DROPBOX XHR LOADER ================= */

function loadCSVXHR(url) {
  return new Promise((resolve, reject) => {
    const xhr = new XMLHttpRequest();
    xhr.open('GET', url, true);
    xhr.onload = () => {
      if (xhr.status === 200) resolve(xhr.responseText);
      else reject(`CSV load failed: ${xhr.status}`);
    };
    xhr.onerror = () => reject('CSV request error');
    xhr.send();
  });
}

/* ================= CSV PARSER (UNCHANGED LOGIC) ================= */

function parseFlatCSV(text, nCol) {
  const m = text
    .replace(/\r/g, ',')
    .replace(/\n/g, '')
    .split(',');

  const obj = {};
  for (let i = 0; i < nCol; i++) obj[m[i]] = [];

  for (let i = nCol; i < m.length; i++) {
    obj[m[i % nCol]].push(m[i].trim());
  }

  return obj;
}

/* ================= LOOKUPS ================= */

function buildLookups() {
  players.forEach(p => playerMap[p.Player] = p);

  if (!roster.Team) {
    console.error('Roster failed to load');
    return;
  }

  roster.Team.forEach((team, i) => {
    if (!teamMap[team]) teamMap[team] = [];
    teamMap[team].push(i);
  });
}

/* ================= STANDINGS ================= */

function buildStandings() {
  const standings = [];

  for (const team in teamMap) {
    let wc = 0, d = 0, cc = 0, sb = 0, inactive = 0, sbw = '';

    teamMap[team].forEach(i => {
      if (roster.Position[i] === 'SB Winner') {
        sbw = roster.TM[i];
        return;
      }

      const p = playerMap[roster.Player[i]];
      wc += +p.WC;
      d += +p.D;
      cc += +p.CC;
      sb += +p.SB;
      inactive += +p.Eliminated;
    });

    standings.push({
      Team: team,
      WC: wc,
      D: d,
      CC: cc,
      SB: sb,
      Total: wc + d + cc + sb,
      SBW: sbw,
      Active: teamMap[team].length - inactive
    });
  }

  standings.sort((a, b) => b.Total - a.Total);
  renderMainTable(standings);
}

/* ================= MAIN TABLE ================= */

function renderMainTable(standings) {
  let html = '<table class="styled-table"><thead><tr>';
  const headers = Object.keys(standings[0]);

  html += '<th>Rank</th>';
  headers.forEach(h => html += `<th>${h}</th>`);
  html += '</tr></thead><tbody>';

  let rank = 1, tie = 1;

  standings.forEach((row, i) => {
    if (i > 0 && row.Total !== standings[i - 1].Total) {
      rank += tie;
      tie = 1;
    } else if (i > 0) tie++;

    html += `<tr><td>${rank}</td>`;
    headers.forEach(h => {
      if (h === 'Team') {
        html += `<td><span class="link" onclick="showTeam('${row[h]}')">${row[h]}</span></td>`;
      } else if (h === 'Total') {
        html += `<td><b>${row[h]}</b></td>`;
      } else {
        html += `<td>${row[h]}</td>`;
      }
    });
    html += '</tr>';
  });

  html += '</tbody></table>';
  document.getElementById('main_table').innerHTML = html;
}

/* ================= TEAM VIEW ================= */

function showTeam(team) {
  const table = document.getElementById('team_table');
  table.replaceWith(originalTeamTable.cloneNode(true));

  let html = `<span class="link" onclick="showMainTable()">Back to Standings</span><br><br>`;
  html += `<b>Team: ${team}</b>`;
  html += `<table class="styled-table"><thead><tr>`;

  const headers = Object.keys(players[0]).filter(h => h !== 'Eliminated');
  headers.forEach(h => html += `<th>${h}</th>`);
  html += '<th>Total</th></tr></thead><tbody>';

  teamMap[team].forEach(i => {
    if (roster.Position[i] === 'SB Winner') return;

    const p = playerMap[roster.Player[i]];
    const total = +p.WC + +p.D + +p.CC + +p.SB;
    const color = p.Eliminated == 1 ? '#FFB2B2' : '#b3ffb3';

    html += '<tr>';
    headers.forEach(h => html += `<td bgcolor="${color}">${p[h]}</td>`);
    html += `<td bgcolor="${color}">${total}</td></tr>`;
  });

  html += '</tbody></table>';
  table.innerHTML = html;

  document.getElementById('main_table').style.display = 'none';
  table.style.display = 'block';
  window.scrollTo(0, 0);
}

/* ================= NAV ================= */

function showMainTable() {
  document.getElementById('main_table').style.display = 'block';
  document.getElementById('team_table').style.display = 'none';
}
</script>

<style>
.styled-table {
  border-collapse: collapse;
  margin: 20px 0;
  font-size: 0.9em;
  font-family: sans-serif;
  min-width: 400px;
  box-shadow: 0 0 20px rgba(0,0,0,0.15);
}
.styled-table thead tr {
  background-color: #00338D;
  color: #fff;
}
.styled-table th,
.styled-table td {
  padding: 12px 15px;
  text-align: center;
}
.styled-table tbody tr:nth-of-type(even) {
  background-color: #f3f3f3;
}
.link {
  color: blue;
  text-decoration: underline;
  cursor: pointer;
}
</style>
</body>
</html>
